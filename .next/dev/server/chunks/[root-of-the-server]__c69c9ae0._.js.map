{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///Users/jeff.cooper/Desktop/cruising_fleet_code/app/api/report/route.ts"],"sourcesContent":["import { list, put, del } from \"@vercel/blob\"\nimport { NextResponse } from \"next/server\"\n\n// Cache for access token\nlet tokenCache: { token: string; expiresAt: number } | null = null\nlet lastRefreshAttempt = 0\nconst MIN_REFRESH_INTERVAL = 60000 // 60 seconds minimum between refresh attempts\nlet rateLimitUntil = 0 // Timestamp when rate limit expires\n\nasync function getAccessToken(forceRefresh = false): Promise<string> {\n  // Check if we're currently rate limited\n  if (rateLimitUntil > Date.now()) {\n    const waitSeconds = Math.ceil((rateLimitUntil - Date.now()) / 1000)\n    throw new Error(`RATE_LIMITED:${waitSeconds}`)\n  }\n\n  // Check if we have a valid cached token (unless forcing refresh)\n  if (!forceRefresh && tokenCache && tokenCache.expiresAt > Date.now()) {\n    console.log(\"[cruising-fleet] Using cached token\")\n    return tokenCache.token\n  }\n\n  const now = Date.now()\n  if (now - lastRefreshAttempt < MIN_REFRESH_INTERVAL) {\n    console.log(\"[cruising-fleet] Rate limit protection: Using cached token to avoid Zoho rate limit\")\n    if (tokenCache) {\n      return tokenCache.token\n    }\n    const waitSeconds = Math.ceil((MIN_REFRESH_INTERVAL - (now - lastRefreshAttempt)) / 1000)\n    throw new Error(`RATE_LIMITED:${waitSeconds}`)\n  }\n\n  lastRefreshAttempt = now\n\n  const params = new URLSearchParams({\n    grant_type: \"refresh_token\",\n    client_id: process.env.ZOHO_CLIENT_ID!,\n    client_secret: process.env.ZOHO_CLIENT_SECRET!,\n    refresh_token: process.env.ZOHO_REFRESH_TOKEN!,\n  })\n\n  console.log(\"[cruising-fleet] Requesting new access token from Zoho\")\n  const response = await fetch(\"https://accounts.zoho.com/oauth/v2/token\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    body: params.toString(),\n  })\n\n  if (!response.ok) {\n    const errorBody = await response.text()\n    console.error(\"[cruising-fleet] Token refresh failed:\", response.status, errorBody)\n\n    if (response.status === 400 && errorBody.includes(\"too many requests\")) {\n      console.log(\"[cruising-fleet] Rate limited by Zoho, setting rate limit period\")\n      // Set rate limit for 2 minutes\n      rateLimitUntil = Date.now() + 2 * 60 * 1000\n      const waitSeconds = 120\n      throw new Error(`RATE_LIMITED:${waitSeconds}`)\n    }\n\n    throw new Error(`Failed to refresh access token: ${response.status}`)\n  }\n\n  const data = await response.json()\n  console.log(\"[cruising-fleet] Successfully got new access token\")\n\n  // Cache the token (expires in 1 hour, we'll cache for 50 minutes to be safe)\n  tokenCache = {\n    token: data.access_token,\n    expiresAt: Date.now() + 50 * 60 * 1000,\n  }\n\n  return data.access_token\n}\n\nasync function fetchReportData(accessToken: string) {\n  const ownerEmail = process.env.ZOHO_OWNER_EMAIL!\n  const workspaceName = encodeURIComponent(process.env.ZOHO_WORKSPACE_NAME!)\n  const reportName = encodeURIComponent(process.env.ZOHO_REPORT_NAME!)\n\n  const url = `https://analyticsapi.zoho.com/api/${ownerEmail}/${workspaceName}/${reportName}?ZOHO_ACTION=EXPORT&ZOHO_OUTPUT_FORMAT=JSON&ZOHO_ERROR_FORMAT=JSON&ZOHO_API_VERSION=1.0`\n\n  const response = await fetch(url, {\n    headers: {\n      Authorization: `Zoho-oauthtoken ${accessToken}`,\n    },\n  })\n\n  return response\n}\n\nasync function syncZohoData() {\n  console.log(\"[cruising-fleet] Syncing fresh data from Zoho...\")\n\n  const accessToken = await getAccessToken()\n  const response = await fetchReportData(accessToken)\n\n  if (!response.ok) {\n    const errorText = await response.text()\n    console.error(\"[cruising-fleet] Zoho API error:\", errorText)\n    throw new Error(`Failed to fetch report data: ${response.status}`)\n  }\n\n  const rawText = await response.text()\n\n  // Fix common JSON escaping issues\n  const cleanedText = rawText\n    .replace(/\\\\/g, \"\\\\\\\\\")\n    .replace(/\\\\\\\\\"/g, '\\\\\"')\n    .replace(/\\\\\\\\n/g, \"\\\\n\")\n    .replace(/\\\\\\\\t/g, \"\\\\t\")\n    .replace(/\\\\\\\\r/g, \"\\\\r\")\n\n  let data\n  try {\n    data = JSON.parse(cleanedText)\n  } catch (parseError) {\n    console.error(\"[cruising-fleet] JSON parse error with cleaned text, trying original:\", parseError)\n    data = JSON.parse(rawText)\n  }\n\n  // Delete all existing blobs before writing the new one\n  const { blobs: existingBlobs } = await list({\n    prefix: \"cruising-fleet-zoho-report-blob\",\n  })\n\n  if (existingBlobs.length > 0) {\n    console.log(`[cruising-fleet] Deleting ${existingBlobs.length} existing blob(s)`)\n    await Promise.all(existingBlobs.map((blob) => del(blob.url)))\n  }\n\n  // Write to Vercel Blob\n  const blob = await put(\"cruising-fleet-zoho-report-blob.json\", JSON.stringify(data), {\n    access: \"public\",\n    contentType: \"application/json\",\n    addRandomSuffix: true,\n  })\n\n  console.log(\"[cruising-fleet] Successfully synced data to Blob:\", blob.url)\n  return data\n}\n\nexport async function GET() {\n  try {\n    const { blobs } = await list({\n      prefix: \"cruising-fleet-zoho-report-blob\",\n    })\n\n    if (blobs.length === 0) {\n      console.log(\"[cruising-fleet] No cached data found in Blob storage, fetching fresh data...\")\n      try {\n        const data = await syncZohoData()\n        return NextResponse.json(data)\n      } catch (syncError) {\n        console.error(\"[cruising-fleet] Failed to sync data:\", syncError)\n\n        // Check if it's a rate limit error\n        if (syncError instanceof Error && syncError.message.startsWith(\"RATE_LIMITED:\")) {\n          const waitSeconds = Number.parseInt(syncError.message.split(\":\")[1])\n          return NextResponse.json(\n            {\n              error: `Zoho API rate limit reached. Please wait ${waitSeconds} seconds and refresh the page.`,\n            },\n            { status: 429, headers: { \"Retry-After\": waitSeconds.toString() } },\n          )\n        }\n\n        throw syncError\n      }\n    }\n\n    // Get the most recent blob (they're sorted by uploadedAt by default)\n    const latestBlob = blobs[0]\n    console.log(\"[cruising-fleet] Reading cached data from Blob:\", latestBlob.pathname)\n\n    // Fetch the blob content\n    const response = await fetch(latestBlob.downloadUrl)\n    if (!response.ok) {\n      throw new Error(`Failed to fetch blob: ${response.status}`)\n    }\n\n    const data = await response.json()\n\n    console.log(\n      \"[cruising-fleet] Blob data retrieved:\",\n      JSON.stringify(\n        {\n          uploadedAt: latestBlob.uploadedAt,\n          hasResponse: !!data.response,\n          rowCount: data.response?.result?.rows?.length || 0,\n        },\n        null,\n        2,\n      ),\n    )\n\n    return NextResponse.json(data)\n  } catch (error) {\n    console.error(\"[cruising-fleet] Error fetching cached report:\", error)\n    return NextResponse.json({ error: \"Failed to fetch cached report data\" }, { status: 500 })\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}